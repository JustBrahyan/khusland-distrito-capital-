<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Khusland — Distrito Capital</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <meta name="theme-color" content="#0f172a">
  <style>
    html,body { background: #0b0f14; color: #e5e7eb; font-family: ui-sans-serif, system-ui; }
    .card { background: linear-gradient(180deg,#0e141b 0%, #0b0f14 100%); border: 1px solid rgba(229,199,123,0.15); border-radius: 1rem; }
    .badge { background: rgba(31,163,109,.12); border: 1px solid rgba(31,163,109,.35); }
    .gold { color: #e5c77b }
    .brand { color:#1fa36d }
    a.link { color:#1fa36d; text-decoration: underline; }
  </style>
</head>
<body class="min-h-screen">
  <header class="sticky top-0 z-30 border-b border-zinc-800/60 bg-[#0b0f14]/80 backdrop-blur">
    <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <h1 class="text-xl font-semibold tracking-wide">Khusland <span class="gold">— Distrito Capital</span></h1>
        <p class="text-xs text-zinc-400 -mt-0.5">Distribuidor Principal de Marihuana Legal</p>
      </div>
      <div class="flex items-center gap-3">
        <input id="icName" type="text" placeholder="Tu nombre IC" class="hidden sm:block w-48 bg-transparent border border-emerald-500/40 rounded-xl px-3 py-2 text-sm outline-none focus:border-emerald-400" />
        <button id="openCart" class="px-3 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white text-sm font-medium">
          🧾 Ver carrito <span id="cartCount" class="ml-1 badge rounded-md px-2 py-0.5 text-emerald-300">0</span>
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-4 py-8">
    <!-- Aviso -->
    <section class="card p-4 mb-6">
      <p class="text-sm text-zinc-300">
        <strong>Importante:</strong> Por favor poner su <strong>nombre IC real</strong>. Si se pone un nombre falso o no conocido <strong>se cancela el pedido</strong>.
      </p>
    </section>

    <!-- Secciones -->
    <section id="catalog" class="grid md:grid-cols-2 gap-6">
      <!-- Sección 1 -->
      <div class="card p-5">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 1 — Bases y Envolturas</h3><p class="text-xs text-zinc-400">Cajas / materiales para armado</p></div>
          <span class="text-sm gold font-semibold">$2,000</span>
        </div>
        <ul id="s1" class="mt-4 space-y-3"></ul>
      </div>

      <!-- Sección 2 -->
      <div class="card p-5">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 2 — Sabores y Mezclas</h3><p class="text-xs text-zinc-400">Bolsas de contenido</p></div>
        </div>
        <div class="mt-4">
          <h4 class="text-sm font-semibold mb-2 brand">Línea Clásica — $2,000</h4>
          <ul id="s2c" class="space-y-3"></ul>
        </div>
        <div class="mt-5">
          <h4 class="text-sm font-semibold mb-2 brand">Línea Premium — $3,000</h4>
          <ul id="s2p" class="space-y-3"></ul>
        </div>
      </div>

      <!-- Sección 3 -->
      <div class="card p-5">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 3 — Joints (cigarros armados)</h3><p class="text-xs text-zinc-400">Venta por unidad</p></div>
          <span class="text-sm gold font-semibold">$3,500</span>
        </div>
        <ul id="s3" class="mt-4 space-y-3"></ul>
      </div>

      <!-- Sección 4 -->
      <div class="card p-5">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 4 — Vapes y Saborizantes</h3><p class="text-xs text-zinc-400">Vapes, mecheros y sabores</p></div>
        </div>
        <div class="mt-4 space-y-5">
          <div>
            <h4 class="text-sm font-semibold mb-2 brand">Vapes y mecheros</h4>
            <ul id="s4-tools" class="space-y-3"></ul>
          </div>
          <div>
            <h4 class="text-sm font-semibold mb-2 brand">Saborizantes — $1,500</h4>
            <ul id="s4-flavors" class="space-y-3"></ul>
          </div>
          <div>
            <h4 class="text-sm font-semibold mb-2 brand">Esencial</h4>
            <ul id="s4-essential" class="space-y-3"></ul>
          </div>
        </div>
      </div>

      <!-- Sección 5 -->
      <div class="card p-5 md:col-span-2">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 5 — Comestibles (K-Edibles)</h3><p class="text-xs text-zinc-400">Alimentos infusionados</p></div>
          <span class="text-sm gold font-semibold">$2,500 – $3,500</span>
        </div>
        <ul id="s5" class="mt-4 grid md:grid-cols-2 gap-3"></ul>
      </div>

      <!-- Sección 6 -->
      <div class="card p-5 md:col-span-2">
        <div class="flex items-start justify-between">
          <div><h3 class="text-lg font-semibold">Sección 6 — Combos Especiales</h3><p class="text-xs text-zinc-400">Packs pensados para negocios</p></div>
        </div>
        <ul id="s6" class="mt-4 grid md:grid-cols-2 gap-3"></ul>
      </div>
    </section>
  </main>

  <!-- Carrito -->
  <aside id="drawer" class="fixed top-0 right-0 h-full w-[92%] sm:w-[420px] translate-x-full transition-transform duration-300 bg-[#0b0f14] border-l border-zinc-800/60 z-40">
    <div class="h-full flex flex-col">
      <div class="p-4 border-b border-zinc-800/60 flex items-center justify-between">
        <h4 class="font-semibold">🧾 Carrito Khusland</h4>
        <button id="closeCart" class="text-zinc-400 hover:text-white">✕</button>
      </div>
      <div class="p-4 border-b border-zinc-800/60">
        <label class="text-xs text-zinc-400">Nombre IC</label>
        <input id="icName2" type="text" placeholder="Escribe tu nombre IC real" class="w-full mt-1 bg-transparent border border-emerald-500/40 rounded-xl px-3 py-2 text-sm outline-none focus:border-emerald-400" />
        <p class="text-[11px] text-amber-300 mt-1">Por favor poner su nombre IC real, si se pone un nombre falso o no conocido se cancela el pedido.</p>
      </div>
      <div id="cartList" class="flex-1 overflow-auto p-4 space-y-3"></div>
      <div class="p-4 border-t border-zinc-800/60">
        <div class="flex items-center justify-between mb-3">
          <span class="text-zinc-400">Total</span>
          <strong id="cartTotal" class="text-lg gold">$0</strong>
        </div>
        <div class="space-y-2">
          <button id="sendServerless" class="w-full px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-500 text-white font-medium">
            Enviar pedido
          </button>
          <button id="clearCart" class="w-full px-4 py-2 rounded-xl border border-zinc-700 text-zinc-300 hover:bg-zinc-800">Vaciar</button>
        </div>
      </div>
    </div>
  </aside>

  <script>
    // ========= CONFIG =========
    // Si alojas en Vercel, crea la variable DISCORD_WEBHOOK_URL y deja este valor vacío.
    // Si pruebas local y tu navegador bloquea por CORS, sube a Vercel.
    const USE_SERVERLESS = true; // usa /api/order
    const WEBHOOK_URL_DIRECT = ""; // deja vacío por seguridad

    // ========= CATÁLOGO =========
    const S1 = [
      {name:'Pure Cone King', price:2000},
      {name:'Preston Pearl', price:2000},
      {name:'Banana Backroot', price:2000},
      {name:'Backroots Honey', price:2000},
      {name:'Backroots Grape', price:2000},
      {name:'Graba Wrap', price:2000},
      {name:'Backroots Cream', price:2000},
    ];
    const S2_CLASSIC = [
      'Berry Muffin','Pure Runs','Endurance Blend','Glacatti','Crisp Gelato',
      'Snowberry Gelato','Elegant Porcelain','Collins Way','Wild Feline','Fluffy OG',
      'Frosties Blend','Frosty Phantom','Grain Cream','Frosted Delight','Azure Tomyz',
      'Zen Blend','Boss Blend','Lunar Stone','Sunset Secret',
    ].map(n=>({name:n, price:2000}));
    const S2_PREMIUM = [
      'Golden Biscuit','Runs Elite','Royal Haze','Spiky Pear','Choco Creme',
      'Bio Crunch','Pastry Blend','Tangy Fuel','Peach Cobbler','Rosy Dunes','Hary Payton',
    ].map(n=>({name:n, price:3000}));
    const S3_JOINTS = [
      'Azure Tomyz','Snowberry Gelato','Bio Crunch','Fluffy OG','Lunar Stone','Pastry Blend',
      'Frosty Phantom','Frosties Blend','Elegant Porcelain','Vapor Essence','Golden Biscuit',
      'Royal Haze','Grain Cream','Berry Muffin','Collins Way','Peach Cobbler','Endurance Blend',
      'Runs Elite','Sunset Secret','Wild Feline','Pure Runs','Zen Blend','Tangy Fuel',
      'Summit OG','Hary Payton','Choco Creme','Spiky Pear','Frosted Delight',
      'Crisp Gelato','Boss Blend','Glacatti','Rosy Dunes'
    ].map(n=>({name:`${n} Joint`, price:3500}));
    const S4_TOOLS = [
      {name:'Cheap Lighter', price:3500},
      {name:'Lighter', price:4000},
      {name:'Vape', price:5000},
    ];
    const S4_FLAVORS = [
      'Paris Mist','Fluffy Crunch','Biscuit Bliss','Spiced Crumble','Fig Delight','Golden Crumble',
      'Clover Crunch','Berry Swirl','Berry Bliss','Bounce Blend','Blend 99','Citrus Crumble'
    ].map(n=>({name:n, price:1500}));
    const S4_ESSENTIAL = [{name:'Vapor Essence', price:1200}];
    const S5_EDIBLES = [
      {name:'Kush Krisps', price:3000},
      {name:'Blaze Bites', price:3000},
      {name:'HighTime Brownie', price:2500},
      {name:'Chronic Crunch', price:3500},
      {name:'Herbal Delight', price:2500},
    ];

    const S6_COMBOS = [
      {name: 'Combo Mayorista Real', price: 38000, items: [
        '20 unidades surtidas','2 porros premium de cortesía'
      ]},
      {name: 'Combo Selección Dorada', price: 28000, items: [
        '10 Premium','1 Golden Biscuit gratis'
      ]},
      {name: 'Combo Light Esencial', price: 11000, items: [
        '5 Clásicos','2 Vapor Essence'
      ]},
    ];

    // ========= Helpers UI =========
    const fmt = n => "$" + n.toLocaleString("es-CO");
    const addRow = (ulId, item) => {
      const li = document.createElement('li');
      li.className = "flex items-center justify-between rounded-xl border border-zinc-800/60 px-3 py-2";
      li.innerHTML = `
        <div>
          <div class="text-sm font-medium">${item.name}</div>
          <div class="text-xs text-zinc-400">${fmt(item.price)}</div>
        </div>
        <div class="flex items-center gap-2">
          <select class="qty border border-zinc-700/80 bg-transparent rounded-lg px-2 py-1 text-sm">
            ${Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
          </select>
          <button class="add px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Agregar</button>
        </div>`;
      li.querySelector('.add').addEventListener('click', ()=>{
        const qty = parseInt(li.querySelector('.qty').value,10);
        addToCart(item, qty);
      });
      document.getElementById(ulId).appendChild(li);
    };

    // Pintar catálogo
    S1.forEach(x=>addRow('s1', x));
    S2_CLASSIC.forEach(x=>addRow('s2c', x));
    S2_PREMIUM.forEach(x=>addRow('s2p', x));
    S3_JOINTS.forEach(x=>addRow('s3', x));
    S4_TOOLS.forEach(x=>addRow('s4-tools', x));
    S4_FLAVORS.forEach(x=>addRow('s4-flavors', x));
    S4_ESSENTIAL.forEach(x=>addRow('s4-essential', x));
    // Combos (presentación)
    const s6 = document.getElementById('s6');
    S6_COMBOS.forEach(c=>{
      const card = document.createElement('div');
      card.className = "rounded-xl border border-zinc-800/60 px-3 py-2";
      card.innerHTML = `
        <div class="flex items-start justify-between">
          <div>
            <div class="text-sm font-semibold">${c.name}</div>
            <ul class="text-xs text-zinc-400 list-disc pl-4 mt-1">${c.items.map(i=>`<li>${i}</li>`).join('')}</ul>
          </div>
          <div class="text-right">
            <div class="text-sm gold font-semibold">${fmt(c.price)}</div>
            <div class="mt-2">
              <select class="qty border border-zinc-700/80 bg-transparent rounded-lg px-2 py-1 text-sm">
                ${Array.from({length:10},(_,i)=>`<option value="${i+1}">${i+1}</option>`).join('')}
              </select>
              <button class="add px-3 py-1.5 rounded-lg bg-emerald-600 hover:bg-emerald-500 text-white text-sm">Agregar</button>
            </div>
          </div>
        </div>`;
      card.querySelector('.add').addEventListener('click', ()=>{
        const qty = parseInt(card.querySelector('.qty').value,10);
        addToCart({name: c.name, price: c.price}, qty);
      });
      s6.appendChild(card);
    });

    // ========= Carrito =========
    let cart = JSON.parse(localStorage.getItem('khusland_cart')||'[]');
    const saveCart = () => localStorage.setItem('khusland_cart', JSON.stringify(cart));
    const cartCountBadge = document.getElementById('cartCount');
    const drawer = document.getElementById('drawer');
    const cartList = document.getElementById('cartList');
    const cartTotal = document.getElementById('cartTotal');
    const openCartBtn = document.getElementById('openCart');
    const closeCartBtn = document.getElementById('closeCart');
    const clearCartBtn = document.getElementById('clearCart');
    const sendBtn = document.getElementById('sendServerless');
    const icNameHeader = document.getElementById('icName');
    const icNameDrawer = document.getElementById('icName2');

    function syncIC() {
      // sincroniza ambos inputs
      icNameDrawer.value = icNameHeader.value || icNameDrawer.value;
      icNameHeader.value = icNameDrawer.value || icNameHeader.value;
    }

    function openDrawer(){ drawer.style.transform = 'translateX(0)'; syncIC(); }
    function closeDrawer(){ drawer.style.transform = 'translateX(100%)'; }

    openCartBtn.onclick = openDrawer;
    closeCartBtn.onclick = closeDrawer;
    clearCartBtn.onclick = () => { cart = []; saveCart(); renderCart(); };

    function addToCart(item, qty=1) {
      const i = cart.findIndex(r=>r.name===item.name && r.price===item.price);
      if (i>=0) cart[i].qty += qty;
      else cart.push({...item, qty});
      saveCart(); renderCart(); openDrawer();
    }
    function totalCart(){ return cart.reduce((s,x)=>s + x.price*x.qty, 0); }
    function renderCart(){
      cartList.innerHTML = '';
      if (!cart.length){
        cartList.innerHTML = '<p class="text-sm text-zinc-400">Tu carrito está vacío.</p>';
      } else {
        cart.forEach((x, idx)=>{
          const row = document.createElement('div');
          row.className = "flex items-center justify-between border border-zinc-800/60 rounded-xl px-3 py-2";
          row.innerHTML = `
            <div>
              <div class="text-sm font-medium">${x.name}</div>
              <div class="text-xs text-zinc-400">c/u ${fmt(x.price)} • ${fmt(x.price*x.qty)}</div>
            </div>
            <div class="flex items-center gap-2">
              <input type="number" min="1" value="${x.qty}" class="w-14 bg-transparent border border-zinc-700 rounded-lg px-2 py-1 text-sm qty"/>
              <button class="del text-zinc-400 hover:text-red-400">🗑️</button>
            </div>`;
          row.querySelector('.qty').addEventListener('change', (e)=>{
            const v = Math.max(1, parseInt(e.target.value,10)||1);
            cart[idx].qty = v; saveCart(); renderCart();
          });
          row.querySelector('.del').addEventListener('click', ()=>{
            cart.splice(idx,1); saveCart(); renderCart();
          });
          cartList.appendChild(row);
        });
      }
      cartTotal.textContent = fmt(totalCart());
      cartCountBadge.textContent = cart.reduce((a,b)=>a + (b.qty||0),0);
    }
    renderCart();

    // ======== Envío del pedido ========
    async function sendOrder(){
      syncIC();
      const ic = icNameDrawer.value.trim();
      if (!ic){ alert("Escribe tu nombre IC real antes de enviar."); return; }
      if (!cart.length){ alert("Tu carrito está vacío."); return; }

      const payload = {
        icName: ic,
        items: cart.map(x=>({ name:x.name, price:x.price, qty:x.qty })),
        total: totalCart()
      };

      try {
        if (USE_SERVERLESS){
          const r = await fetch("/api/order", {
            method: "POST",
            headers: { "Content-Type":"application/json" },
            body: JSON.stringify(payload)
          });
          if (!r.ok) throw new Error("Respuesta no OK del servidor");
        } else {
          if (!WEBHOOK_URL_DIRECT) throw new Error("Configura WEBHOOK_URL_DIRECT para envío directo.");
          // intento directo (puede fallar por CORS)
          const embedPayload = {
            embeds: [{
              title: "📦 Nuevo pedido — Khusland (Distrito Capital)",
              description: payload.items.map(x=>`• ${x.name} x${x.qty} — $${(x.price*x.qty).toLocaleString('es-CO')}`).join("\n"),
              color: 0xe5c77b,
              fields: [
                { name: "Nombre IC", value: ic, inline: true },
                { name: "Total", value: "$" + payload.total.toLocaleString("es-CO"), inline: true },
                { name: "Estado", value: "⏳ Pendiente" }
              ],
              footer: { text: "Khusland — La raíz del negocio legal" },
              timestamp: new Date().toISOString()
            }]
          };
          const r = await fetch(WEBHOOK_URL_DIRECT, { method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(embedPayload) });
          if (!r.ok) throw new Error("Error al enviar el webhook directo");
        }

        alert("✅ Pedido enviado. Te contactaremos para la entrega.");
        cart = []; saveCart(); renderCart(); closeDrawer();
      } catch (e) {
        alert("❌ No se pudo enviar el pedido. Sube el proyecto a Vercel y configura DISCORD_WEBHOOK_URL.");
      }
    }

    document.getElementById('sendServerless').onclick = sendOrder;
  </script>
</body>
</html>
