<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Khusland — Distrito Capital</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
html,body{background:#0b0f14;color:#e5e7eb;font-family:system-ui,sans-serif}
.card{background:linear-gradient(180deg,#0f1621,#0b0f14);border:1px solid rgba(229,199,123,.15);border-radius:1rem}
.gold{color:#e5c77b}
.pill{border:1px solid #2a3138;border-radius:999px;padding:.35rem .75rem;font-size:.85rem}
.btn{border-radius:.8rem;padding:.6rem 1rem;font-weight:600}
.btn-emerald{background:#1fa36d}
.btn-emerald:hover{background:#19905f}
.grid-cards{display:grid;grid-template-columns:repeat(1,minmax(0,1fr));gap:1rem}
@media(min-width:640px){.grid-cards{grid-template-columns:repeat(2,minmax(0,1fr))}}
@media(min-width:1024px){.grid-cards{grid-template-columns:repeat(3,minmax(0,1fr))}}
.tag{font-size:.7rem;border:1px solid rgba(229,199,123,.35);border-radius:.45rem;padding:.1rem .4rem;color:#e5c77b}
.shadow-gold{box-shadow:0 0 0 1px rgba(229,199,123,.25),0 20px 60px rgba(229,199,123,.12) inset}
.shadow-emerald{box-shadow:0 0 0 1px rgba(31,163,109,.25),0 20px 60px rgba(31,163,109,.12) inset}
</style>
</head>
<body>
<header class="sticky top-0 z-30 border-b border-zinc-800/60 bg-[#0b0f14]/80 backdrop-blur">
  <div class="max-w-6xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-full bg-gradient-to-br from-emerald-500 to-emerald-800 shadow-emerald grid place-items-center">
        <span class="text-xl">🌿</span>
      </div>
      <div>
        <h1 class="text-lg font-semibold leading-tight">Khusland <span class="gold">— Distrito Capital</span></h1>
        <p class="text-xs text-zinc-400 -mt-0.5">Distribuidor Principal • Marihuana Legal</p>
      </div>
    </div>
    <button id="openCart" class="pill text-emerald-300 border-emerald-800">🛒 Carrito <span id="cartCount" class="ml-1 text-zinc-400">(0)</span></button>
  </div>
</header>

<main class="max-w-6xl mx-auto px-4 py-6">
  <div class="flex flex-wrap gap-2 mb-5">
    <button data-tab="s1" class="pill tabbtn">Bases</button>
    <button data-tab="s2" class="pill tabbtn">Mezclas</button>
    <button data-tab="s3" class="pill tabbtn">Joints</button>
    <button data-tab="s4" class="pill tabbtn">Vapes</button>
    <button data-tab="s5" class="pill tabbtn">Esencias</button>
    <button data-tab="s6" class="pill tabbtn">Comestibles</button>
    <button data-tab="packs" class="pill tabbtn">📦 Packs</button>
  </div>

  <section id="s1" class="space-y-3">
    <h2 class="text-xl font-semibold">🧱 Bases y Envolturas <span class="text-sm text-zinc-400">($3,000 c/u)</span></h2>
    <div class="grid-cards" id="list-s1"></div>
  </section>

  <section id="s2" class="space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">🍇 Mezclas y Sabores</h2>
      <div class="flex gap-2 text-xs">
        <span class="tag">Standard $3,000</span>
        <span class="tag">Premium $4,000</span>
      </div>
    </div>
    <h3 class="text-sm text-zinc-400">Standard</h3>
    <div class="grid-cards" id="list-s2-standard"></div>
    <h3 class="text-sm text-zinc-400 mt-2">Premium</h3>
    <div class="grid-cards" id="list-s2-premium"></div>
  </section>

  <section id="s3" class="space-y-3 hidden">
    <h2 class="text-xl font-semibold">🚬 Joints <span class="text-sm text-zinc-400">($3,500 c/u)</span></h2>
    <div class="grid-cards" id="list-s3"></div>
  </section>

  <section id="s4" class="space-y-3 hidden">
    <h2 class="text-xl font-semibold">💨 Vapes (Dispositivos)</h2>
    <div class="grid-cards" id="list-s4"></div>
  </section>

  <section id="s5" class="space-y-3 hidden">
    <h2 class="text-xl font-semibold">🧴 Esencias / Saborizantes para Vape</h2>
    <div class="grid-cards" id="list-s5"></div>
  </section>

  <section id="s6" class="space-y-3 hidden">
    <h2 class="text-xl font-semibold">🍪 Comestibles (Edibles)</h2>
    <div class="grid-cards" id="list-s6"></div>
  </section>

  <section id="packs" class="space-y-3 hidden">
    <div class="flex items-center justify-between">
      <h2 class="text-xl font-semibold">📦 Packs Empresariales Khusland</h2>
      <span class="tag">Solo negocios autorizados</span>
    </div>
    <p class="text-sm text-zinc-400">🕒 <b>Límite global:</b> 1 pack por negocio cada 24h. Pedidos sin licencia serán rechazados.</p>
    <div class="grid-cards" id="list-packs"></div>
    <div class="card p-4">
      <p class="text-amber-300 text-sm">⚠️ Aviso legal: Los packs empresariales están restringidos a negocios con licencia emitida por la <b>Gobernación del Distrito Capital</b>. Pedidos no verificados serán <b>rechazados automáticamente</b>.</p>
    </div>
  </section>
</main>

<div id="drawer" class="fixed inset-0 z-40 hidden">
  <div class="absolute inset-0 bg-black/60"></div>
  <aside class="absolute right-0 top-0 h-full w-full sm:w-[420px] bg-[#0b0f14] border-l border-zinc-800 p-5 overflow-y-auto">
    <div class="flex items-center justify-between mb-3">
      <h3 class="text-lg font-semibold">🛒 Carrito</h3>
      <button id="closeCart" class="pill">✕</button>
    </div>
    <div id="cartItems" class="space-y-3"></div>
    <div class="border-t border-zinc-800 mt-4 pt-4">
      <div class="flex items-center justify-between">
        <span class="text-zinc-400">Subtotal</span>
        <span id="cartSubtotal" class="font-semibold">$0</span>
      </div>
      <button id="checkoutBtn" class="btn btn-emerald w-full mt-3">Realizar pedido</button>
      <p class="text-xs text-zinc-400 mt-2">Al confirmar, deberás indicar si eres <b>Individual</b> o <b>Negocio</b>.</p>
    </div>
  </aside>
</div>

<div id="modal" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/70"></div>
  <div class="relative max-w-lg mx-auto mt-16 card p-6">
    <h3 class="text-lg font-semibold mb-1">Confirmar pedido</h3>
    <p class="text-sm text-zinc-400 mb-4">Selecciona el tipo de cliente y completa los datos requeridos.</p>

    <div class="flex gap-2 mb-3">
      <button class="pill" data-type="individual">🧍 Individual</button>
      <button class="pill" data-type="negocio">🏢 Negocio</button>
    </div>

    <div id="formIndividual" class="space-y-2 hidden">
      <label class="text-sm">Nombre IC real</label>
      <input id="icName" class="w-full bg-transparent border border-zinc-700 rounded-lg px-3 py-2" placeholder="Tu nombre IC real" />
      <p class="text-xs text-amber-300">*Por favor ingresar tu nombre IC real; si usas uno falso, el pedido será cancelado.</p>
    </div>

    <div id="formNegocio" class="space-y-2 hidden">
      <label class="text-sm">Nombre del negocio</label>
      <input id="bizName" class="w-full bg-transparent border border-zinc-700 rounded-lg px-3 py-2" placeholder="Nombre registrado" />
      <label class="text-sm">Postal del negocio</label>
      <input id="bizPostal" class="w-full bg-transparent border border-zinc-700 rounded-lg px-3 py-2" placeholder="Código / dirección postal" />
      <p class="text-xs text-amber-300">*Solo para negocios autorizados por Khusland y la Gobernación del Distrito Capital.</p>
    </div>

    <div class="mt-4 flex items-center justify-between">
      <button id="cancelModal" class="pill">Cancelar</button>
      <button id="sendOrder" class="btn btn-emerald">Enviar pedido</button>
    </div>

    <p class="text-xs text-zinc-400 mt-3">📸 Al enviar: <b>toma captura</b> y abre <b>ticket</b> para coordinar día y horario de entrega.</p>
  </div>
</div>

<script>
// Utils
const money = n => "$" + Number(n).toLocaleString("es-CO");

// Catálogo
const S1 = ['Pure Cone King','Preston Pearl','Banana Backroot','Backroots Honey','Backroots Grape','Graba Wrap','Backroots Cream']
  .map(n => ({name:n, price:3000, img:'🧱'}));

const S2_STANDARD = [
  'Berry Muffin','Pure Runs','Endurance Blend','Crisp Gelato','Fluffy OG','Pastry Blend','Frosty Phantom','Grain Cream','Zen Blend','Boss Blend','Lunar Stone','Sunset Secret','Elegant Porcelain','Glacatti','Frosties Blend','Collins Way','Wild Feline','Vapor Essence (Mezcla)'
].map(n => ({name:n, price:3000, img:'🍇'}));

const S2_PREMIUM = [
  'Golden Biscuit','Runs Elite','Snowberry Gelato','Royal Haze','Spiky Pear','Choco Creme','Bio Crunch','Tangy Fuel','Frosted Delight','Azure Tomyz','Peach Cobbler','Rosy Dunes','Hary Payton'
].map(n => ({name:n, price:4000, img:'💎'}));

const S3 = [
  'Berry Muffin Joint','Golden Biscuit Joint','Snowberry Gelato Joint','Royal Haze Joint','Crisp Gelato Joint','Azure Tomyz Joint','Peach Cobbler Joint','Glacatti Joint','Frosties Blend Joint','Elegant Porcelain Joint','Collins Way Joint','Wild Feline Joint','Zen Blend Joint','Boss Blend Joint','Runs Elite Joint','Frosted Delight Joint','Hary Payton Joint','Spiky Pear Joint','Crisp Gelato Joint','Choco Creme Joint','Pastry Blend Joint','Grain Cream Joint','Tangy Fuel Joint','Lunar Stone Joint','Sunset Secret Joint','Rosy Dunes Joint','Pure Runs Joint'
].map(n => ({name:n, price:3500, img:'🚬'}));

const S4 = [
  {name:'Cheap Lighter', price:3500, img:'⚡'},
  {name:'Lighter', price:4000, img:'⚡'},
  {name:'Vape', price:5000, img:'💨'},
];

const S5 = [
  {name:'Blend 99', price:3500, img:'🧴'},
  {name:'Citrus Crumble', price:3500, img:'🧴'},
  {name:'Paris Mist', price:4000, img:'🧴'},
  {name:'Fluffy Crunch', price:3500, img:'🧴'},
  {name:'Biscuit Bliss', price:4000, img:'🧴'},
  {name:'Spiced Crumble', price:3500, img:'🧴'},
  {name:'Fig Delight', price:4000, img:'🧴'},
  {name:'Golden Crumble', price:4000, img:'🧴'},
  {name:'Clover Crunch', price:3500, img:'🧴'},
  {name:'Berry Swirl', price:3500, img:'🧴'},
  {name:'Berry Bliss', price:4000, img:'🧴'},
  {name:'Bounce Blend', price:3500, img:'🧴'},
];

const S6 = [
  {name:'Kush Krisps', price:4000, img:'🍪'},
  {name:'Blaze Bites', price:4000, img:'🍪'},
  {name:'HighTime Brownie', price:5000, img:'🍫'},
  {name:'Chronic Crunch', price:5000, img:'🍪'},
  {name:'Herbal Delight', price:4000, img:'🍪'},
];

// Packs (nuevos precios con ahorro > 0)
const PACKS = [
  {
    id:'pack-punto-verde',
    name:'Pack Punto Verde',
    price:26000,
    items:[
      {name:'Base', price:3000, qty:2},
      {name:'Mezcla Standard', price:3000, qty:2},
      {name:'Joint', price:3500, qty:2},
      {name:'Esencia', price:3500, qty:1},
      {name:'Comestible', price:4000, qty:1},
    ],
    summary:'8 ítems — ~25 porros',
    img:'🌿📦'
  },
  {
    id:'pack-distribuidor',
    name:'Pack Distribuidor Oficial',
    price:65000,
    items:[
      {name:'Base', price:3000, qty:5},
      {name:'Mezcla Premium', price:4000, qty:5},
      {name:'Joint', price:3500, qty:5},
      {name:'Vape', price:5000, qty:2},
      {name:'Esencia Premium', price:4000, qty:2},
      {name:'Comestible', price:4000, qty:3},
    ],
    summary:'22 ítems — ~50 porros',
    img:'🏛️📦'
  },
  {
    id:'pack-elite',
    name:'Pack Elite Khusland',
    price:130000,
    items:[
      {name:'Base', price:3000, qty:10},
      {name:'Mezcla Premium', price:4000, qty:10},
      {name:'Joint', price:3500, qty:10},
      {name:'Vape', price:5000, qty:5},
      {name:'Esencia Premium', price:4000, qty:5},
      {name:'Comestible Premium', price:5000, qty:5},
    ],
    summary:'45 ítems — ~100 porros',
    img:'💎📦'
  },
  {
    id:'pack-vape-station',
    name:'Pack Vape Station',
    price:42000,
    items:[
      {name:'Vape', price:5000, qty:4},
      {name:'Esencia Premium', price:4000, qty:6},
    ],
    summary:'10 ítems — vapeadores + recargas',
    img:'💨📦'
  },
  {
    id:'pack-edible-cafe',
    name:'Pack Edible Café',
    price:42000,
    items:[
      {name:'Base', price:3000, qty:4},
      {name:'Mezcla Dulce', price:3000, qty:4},
      {name:'Comestible', price:4000, qty:5},
    ],
    summary:'13 ítems — ideal para cafés',
    img:'🍪📦'
  },
  {
    id:'pack-multi-line',
    name:'Pack Multi-Line',
    price:76000,
    items:[
      {name:'Base', price:3000, qty:5},
      {name:'Mezcla Premium', price:4000, qty:5},
      {name:'Joint', price:3500, qty:5},
      {name:'Vape', price:5000, qty:2},
      {name:'Esencia', price:3500, qty:2},
      {name:'Comestible', price:4000, qty:3},
    ],
    summary:'22 ítems — mixto para todo',
    img:'🧩📦'
  },
];

// Render helpers
function cssId(s){ return s.toLowerCase().replace(/[^a-z0-9]+/g,'-'); }
function cardTemplate(p){ return `
  <div class="card p-4">
    <div class="flex items-center justify-between gap-3">
      <div class="text-3xl">${p.img||'🌿'}</div>
      ${p.tier?`<span class="tag">${p.tier}</span>`:''}
    </div>
    <h4 class="mt-2 font-semibold">${p.name}</h4>
    <div class="text-sm text-zinc-400">${money(p.price)}</div>
    <div class="mt-3 flex items-center gap-2">
      <button class="pill qtyminus" data-name="${p.name}" data-price="${p.price}">–</button>
      <span id="q_${cssId(p.name)}" class="min-w-[2ch] inline-block text-center">0</span>
      <button class="pill qtyplus" data-name="${p.name}" data-price="${p.price}">+</button>
      <button class="btn btn-emerald ml-auto add" data-name="${p.name}" data-price="${p.price}">Agregar</button>
    </div>
  </div>`;
}

function packTemplate(pk){
  const base = pk.items.reduce((a,x)=>a + x.price*x.qty, 0);
  const ahorro = Math.max(0, ((1 - pk.price/base)*100));
  const ahorroFmt = (ahorro < 1 && ahorro > 0) ? ahorro.toFixed(1) : Math.round(ahorro);
  return `
  <div class="card p-4 shadow-gold">
    <div class="flex items-center justify-between">
      <div class="text-3xl">${pk.img}</div>
      <span class="tag">Límite global</span>
    </div>
    <h4 class="mt-2 font-semibold">${pk.name}</h4>
    <div class="text-sm text-zinc-400 mb-2">${pk.summary}</div>
    <ul class="text-sm text-zinc-300 list-disc pl-5 space-y-0.5">
      ${pk.items.map(x=>`<li>${x.name} × ${x.qty}</li>`).join('')}
    </ul>
    <div class="mt-3 text-sm">
      <div>Precio original: <s>${money(base)}</s></div>
      <div>Precio pack: <span class="gold font-semibold">${money(pk.price)}</span></div>
      <div class="text-emerald-400">Ahorro: ${ahorroFmt}%</div>
    </div>
    <button class="btn btn-emerald w-full mt-3 add-pack" data-pack="${pk.id}">Solicitar Pack Empresarial</button>
  </div>`;
}

function renderAll(){
  document.getElementById('list-s1').innerHTML = S1.map(cardTemplate).join('');
  document.getElementById('list-s2-standard').innerHTML = S2_STANDARD.map(x=>cardTemplate({...x, tier:'Standard'})).join('');
  document.getElementById('list-s2-premium').innerHTML = S2_PREMIUM.map(x=>cardTemplate({...x, tier:'Premium'})).join('');
  document.getElementById('list-s3').innerHTML = S3.map(cardTemplate).join('');
  document.getElementById('list-s4').innerHTML = S4.map(cardTemplate).join('');
  document.getElementById('list-s5').innerHTML = S5.map(cardTemplate).join('');
  document.getElementById('list-s6').innerHTML = S6.map(cardTemplate).join('');
  document.getElementById('list-packs').innerHTML = PACKS.map(packTemplate).join('');
  wireCards();
}

// Cart
let CART = [];
function addItem(name, price, qty){
  qty = Math.max(1, qty||1);
  const key = name + '|' + price;
  const found = CART.find(i=>i.key===key);
  if(found){ found.qty += qty; }
  else { CART.push({ key, name, price, qty }); }
  updateCart();
}
function updateCart(){
  const count = CART.reduce((a,x)=>a+x.qty,0);
  document.getElementById('cartCount').textContent = '('+count+')';

  const wrap = document.getElementById('cartItems');
  wrap.innerHTML = '';
  let subtotal = 0;
  CART.forEach((i,idx)=>{
    subtotal += i.price * i.qty;
    const row = document.createElement('div');
    row.className = 'flex items-start justify-between gap-3 border-b border-zinc-800 pb-3';
    row.innerHTML = `
      <div>
        <div class="font-medium">${i.name}</div>
        <div class="text-xs text-zinc-400">${money(i.price)} × ${i.qty}</div>
      </div>
      <div class="flex items-center gap-2">
        <button class="pill dec" data-idx="${idx}">–</button>
        <button class="pill inc" data-idx="${idx}">+</button>
        <button class="pill rm" data-idx="${idx}">🗑️</button>
      </div>
    `;
    wrap.appendChild(row);
  });
  document.getElementById('cartSubtotal').textContent = money(subtotal);

  wrap.querySelectorAll('.dec').forEach(b=>b.onclick = ()=>{ const i=CART[b.dataset.idx]; if(i.qty>1)i.qty--; updateCart(); });
  wrap.querySelectorAll('.inc').forEach(b=>b.onclick = ()=>{ const i=CART[b.dataset.idx]; i.qty++; updateCart(); });
  wrap.querySelectorAll('.rm').forEach(b=>b.onclick = ()=>{ CART.splice(b.dataset.idx,1); updateCart(); });
}

function wireCards(){
  document.querySelectorAll('.qtyplus').forEach(b=>{
    b.onclick = ()=>{
      const id = 'q_'+cssId(b.dataset.name);
      const el = document.getElementById(id);
      el.textContent = Number(el.textContent)+1;
    }
  });
  document.querySelectorAll('.qtyminus').forEach(b=>{
    b.onclick = ()=>{
      const id = 'q_'+cssId(b.dataset.name);
      const el = document.getElementById(id);
      const n = Math.max(0, Number(el.textContent)-1);
      el.textContent = n;
    }
  });
  document.querySelectorAll('.add').forEach(b=>{
    b.onclick = ()=>{
      const id = 'q_'+cssId(b.dataset.name);
      const qty = Math.max(1, Number(document.getElementById(id).textContent)||1);
      addItem(b.dataset.name, Number(b.dataset.price), qty);
      document.getElementById(id).textContent = 0;
    }
  });
  document.querySelectorAll('.add-pack').forEach(b=>{
    b.onclick = ()=>{
      const last = Number(localStorage.getItem('khusland_pack_last')||0);
      const now = Date.now();
      if((now - last) < 24*60*60*1000){
        alert('🚫 Ya realizaste una compra empresarial hoy. Solo se permite un pack cada 24h por negocio.');
        return;
      }
      const pk = PACKS.find(x=>x.id===b.dataset.pack);
      if(!pk) return;
      addItem(pk.name + ' (Pack)', pk.price, 1);
      localStorage.setItem('khusland_pack_last', String(now));
      openCart();
    }
  });
}

// Tabs
const tabs = Array.from(document.querySelectorAll('.tabbtn'));
const secs = ['s1','s2','s3','s4','s5','s6','packs'];
tabs.forEach(btn=>{
  btn.onclick = ()=>{
    secs.forEach(id=> document.getElementById(id).classList.add('hidden'));
    document.getElementById(btn.dataset.tab).classList.remove('hidden');
    tabs.forEach(b=> b.classList.remove('border-emerald-700','text-emerald-300'));
    btn.classList.add('border-emerald-700','text-emerald-300');
    window.scrollTo({top:0, behavior:'smooth'});
  }
});
document.querySelector('[data-tab="s1"]').click();

// Drawer
const drawer = document.getElementById('drawer');
const openCartBtn = document.getElementById('openCart');
const closeCartBtn = document.getElementById('closeCart');
function openCart(){ drawer.classList.remove('hidden'); }
function closeCart(){ drawer.classList.add('hidden'); }
openCartBtn.onclick = openCart;
closeCartBtn.onclick = closeCart;
drawer.querySelector('.absolute.inset-0').onclick = closeCart;

// Checkout modal
const modal = document.getElementById('modal');
const checkoutBtn = document.getElementById('checkoutBtn');
const cancelModal = document.getElementById('cancelModal');
const sendOrder = document.getElementById('sendOrder');
const formIndividual = document.getElementById('formIndividual');
const formNegocio = document.getElementById('formNegocio');
const icName = document.getElementById('icName');
const bizName = document.getElementById('bizName');
const bizPostal = document.getElementById('bizPostal');

let customerType = null;
document.querySelectorAll('[data-type]').forEach(b=>{
  b.onclick = ()=>{
    customerType = b.dataset.type;
    formIndividual.classList.toggle('hidden', customerType!=='individual');
    formNegocio.classList.toggle('hidden', customerType!=='negocio');
  };
});

checkoutBtn.onclick = ()=>{
  if(CART.length===0){ alert('Tu carrito está vacío.'); return; }
  modal.classList.remove('hidden');
};
cancelModal.onclick = ()=> modal.classList.add('hidden');

sendOrder.onclick = async ()=>{
  if(!customerType){ alert('Selecciona si eres Individual o Negocio.'); return; }
  let ic = '';
  if(customerType==='individual'){
    if(!icName.value.trim()){ alert('Ingresa tu nombre IC real.'); return; }
    ic = `[IND] ${icName.value.trim()}`;
  }else{
    if(!bizName.value.trim() || !bizPostal.value.trim()){
      alert('Ingresa el nombre del negocio y su postal.');
      return;
    }
    ic = `[NEG] ${bizName.value.trim()} | Postal ${bizPostal.value.trim()}`;
  }

  const items = CART.map(i=>({ name:i.name, qty:i.qty, price:i.price }));
  const total = items.reduce((a,x)=>a+x.price*x.qty,0);

  try{
    const r = await fetch('/api/order', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ icName: ic, items, total })
    });
    if(!r.ok){ throw new Error('Error al enviar pedido'); }
    CART = [];
    updateCart();
    modal.classList.add('hidden');
    closeCart();
    alert('✅ Pedido enviado. 📸 Toma captura y abre ticket para coordinar día y horario de entrega.');
  }catch(e){
    alert('No se pudo enviar el pedido. Intenta de nuevo.');
  }
};

// init
renderAll();
updateCart();
</script>
</body>
</html>
